# DS_example_minimal – DevSecOps-сканы и харднинг (пример «минимум на 1»)

> Пример для ориентира: как может выглядеть заполненный DS на базовый уровень.  
> Проект вымышленный, домен упрощён (тот же «FoodGo», что и в TM/DV).

---

## 0) Мета

- **Проект (опционально BYO):** Учебный сервис онлайн-заказа еды «FoodGo»
- **Версия (commit/date):** abc123 / 2025-11-21
- **Кратко (1-2 предложения):**  
  Сканы и харднинг для Docker-образа и репозитория «FoodGo»: SBOM+SCA, SAST+secrets, базовые policy-проверки Trivy и 2 меры харднинга (non-root контейнер, работа с секретами).

---

## 1) SBOM и уязвимости зависимостей (DS1)

- **Инструменты/формат:** Syft + Grype, формат SBOM – CycloneDX JSON.

**Как запускал:**

```bash
# генерация SBOM
syft dir:. -o cyclonedx-json > EVIDENCE/foodgo-sbom-2025-11-21.json

# SCA по SBOM
grype sbom:EVIDENCE/foodgo-sbom-2025-11-21.json \
  --fail-on high \
  -o json > EVIDENCE/foodgo-sca-2025-11-21.json
```

- **Отчёты:**

  - `EVIDENCE/foodgo-sbom-2025-11-21.json`
  - `EVIDENCE/foodgo-sca-2025-11-21.json`

**Выводы (кратко):**

- Critical: **0**
- High: **1** (библиотека `urllib3 1.26.7`, CVE-2023-43804, тянется через `requests`)
- Medium/Low: несколько типичных CVE в зависимостях Python/OS (подробно в отчёте).

**Действия:**

- Зафиксировал CVE для `urllib3` в триаж-таблице (см. раздел 6).
- На уровне «лайт» пока **не обновлял** зависимости, отметил задачу на будущий минорный релиз.
- Отдельно записал, что при bump’е нужно будет прогнать тесты и повторить SCA.

**Гейт по зависимостям (словами):**

- На текущем этапе (минимум на 1):

  - **Critical = 0** – релиз запрещён, пока не разобрались.
  - **High ≤ 1** – допустимо, но запись в триаж и задача на анализ/фикс.
- Проверка порога пока **ручная**: смотрю сводку Grype и триаж-таблицу перед релизом.

---

## 2) SAST и Secrets (DS2)

### 2.1 SAST

- **Инструмент/профиль:** Semgrep, публичный профиль `p/ci`, фокус на high severity.

**Как запускал:**

```bash
semgrep --config p/ci \
        --severity=high \
        --error \
        --json \
        --output EVIDENCE/foodgo-sast-2025-11-21.json
```

- **Отчёт:** `EVIDENCE/foodgo-sast-2025-11-21.json`

**Выводы:**

- Всего high-уровня: **1** правило срабатывает на код в `app/order_repository.py` (конкатенация строки в запросе).
- При ручном просмотре видно, что фактически используется параметризация, но Semgrep триггерится на общий шаблон.
- На уровне «лайт» **фикс пока не делал**, оставил задачу «аккуратнее переписать участок» в issue-трекере.
- Остальные срабатывания либо informational, либо низкой важности.

---

### 2.2 Secrets scanning

- **Инструмент:** Gitleaks.

**Как запускал (рабочая директория – корень проекта):**

```bash
# скан текущего рабочего дерева
gitleaks detect \
  --no-git \
  --report-format json \
  --report-path EVIDENCE/foodgo-secrets-2025-11-21.json

# скан истории git
gitleaks detect \
  --log-opts="--all" \
  --report-format json \
  --report-path EVIDENCE/foodgo-secrets-history-2025-11-21.json
```

- **Отчёты:**

  - `EVIDENCE/foodgo-secrets-2025-11-21.json`
  - `EVIDENCE/foodgo-secrets-history-2025-11-21.json`

**Выводы:**

- В текущем дереве – только пару срабатываний на строки вида `TEST_API_KEY=example`, используемые в учебных примерах.
- В истории git реальных секретов (паролей/токенов к боевым сервисам) не нашли.
- Эти срабатывания считаю **false positive**, но suppression-конфиг пока **не заводил**, просто зафиксировал выводы здесь.

---

## 3) Policy / Container / IaC (DS3)

> Для минимального уровня беру **policy/container-вариант**, без полноценного DAST-профиля.

- **Инструменты:** Trivy для образа и конфигов.

**Как запускал:**

```bash
# скан Docker-образа (HIGH/CRITICAL пакеты)
trivy image \
  --severity HIGH,CRITICAL \
  foodgo-app:local > EVIDENCE/foodgo-trivy-image-2025-11-21.txt

# скан конфигурации (Dockerfile и манифесты) на базовые misconfig
trivy config . \
  --severity HIGH,CRITICAL \
  > EVIDENCE/foodgo-trivy-config-2025-11-21.txt
```

- **Отчёты:**

  - `EVIDENCE/foodgo-trivy-image-2025-11-21.txt`
  - `EVIDENCE/foodgo-trivy-config-2025-11-21.txt`

**Выводы:**

- По образу: Trivy повторно подсветил ту же CVE по `urllib3`, что и Grype (High).
- По конфигам:

  - предупреждение о том, что можно дополнительно уменьшить образ (использовать slim/busybox);
  - рекомендация явно указать non-root пользователя – это уже сделано (см. раздел 4, харднинг).
- Новых критичных misconfig, требующих немедленного действия, не обнаружено; часть рекомендаций отложена «на потом».

---

## 4) Харднинг (доказуемый) (DS4)

Отмечаю **реально сделанные** меры, не просто «хотим когда-нибудь».

- [x] **Контейнер non-root / drop capabilities**

  - В `Dockerfile` добавлен пользователь `appuser`, контейнер запускается не от root.
  - Evidence: фрагмент Dockerfile сохранён в `EVIDENCE/foodgo-dockerfile-user-snippet.txt`,
    а Trivy не ругается на запуск от root (см. `EVIDENCE/foodgo-trivy-config-2025-11-21.txt`).

- [x] **Secrets handling (нет секретов в git; .env + Secrets в CI)**

  - Реальный `.env` добавлен в `.gitignore`, в репе лежит только `.env.example` без значений.
  - В CI секреты планируется передавать через настройки репозитория (GitHub Secrets).
  - Evidence: отчёты Gitleaks `EVIDENCE/foodgo-secrets-2025-11-21.json` и `EVIDENCE/foodgo-secrets-history-2025-11-21.json` с нулём реальных секретов.

- [ ] Rate-limit / timeouts / retry budget

- [ ] HTTP security headers / CSP / HTTPS-only

- [ ] AuthZ / RLS / tenant isolation

- [ ] Container/IaC best-practice (readonly fs, минимальная база и т.п.)

Для «лайт»-уровня считаю достаточным 2 уместные меры с понятными доказательствами.

---

## 5) Quality-gates и проверка порогов (DS5)

**Пороговые правила (словами):**

- **SCA:** Critical = 0, High ≤ 1. Если High > 1 – остановка до анализа.
- **SAST:** High = 0. При появлении хотя бы одного High – нужно либо исправить, либо признать FP (с описанием).
- **Secrets:** 0 истинных находок (в текущем дереве и в истории).
- **Policy (Trivy config):** HIGH/CRITICAL misconfig = 0. Остальные рекомендации – в backlog.

**Как проверяются сейчас (минимальный уровень):**

- Сканы запускаю **вручную** перед важными изменениями или релизом:

  - `syft` + `grype` для SCA;
  - `semgrep` для SAST;
  - `gitleaks` для secrets;
  - `trivy image/config` для policy.
- Смотрю сводку по каждому инструменту и сравниваю с порогами выше.
- Если порог нарушен – создаю issue в трекере и считаю релиз «заблокированным», пока не принято решение.

Автоматического job’а в CI, который бы падал по этим порогам, пока **нет** – это уже уровень ближе к «2».

---

## 6) Триаж-лог (fixed / suppressed / open)

Таблица по ключевым находкам из сканов:

| ID/Anchor         | Класс   | Severity | Статус | Действие  | Evidence                                             | Ссылка на фикс/исключение | Комментарий / owner / expiry            |
| ----------------- | ------- | -------- | ------ | --------- | ---------------------------------------------------- | ------------------------- | --------------------------------------- |
| CVE-2023-43804    | SCA     | High     | open   | backlog   | `EVIDENCE/foodgo-sca-2025-11-21.json#CVE-2023-43804` | issue #12                 | запланировать bump в минорном релизе    |
| SAST-1-order-repo | SAST    | High     | open   | review    | `EVIDENCE/foodgo-sast-2025-11-21.json#1`             | issue #13                 | возможно FP; нужно переписать код позже |
| SECR-TEST-KEY     | Secrets | Medium   | open   | review/FP | `EVIDENCE/foodgo-secrets-2025-11-21.json#1`          | –                         | учебный тестовый ключ, не боевой        |

На уровне «1» достаточно, что находки не потерялись, по ним есть понятный статус и ссылки на отчёты/issue.
Owner/expiry для подавлений пока не задавал, suppression-конфиги не использую.

---

## 7) Эффект «до/после» (метрики) (DS4/DS5)

Показываю простой пример «до/после» по покрытию security-инструментами перед релизом:

| Контроль/Мера     | Метрика                                    | До (задания не пройдены)  | После (настройка DS)           | Evidence                                                                                          |
| ----------------- | ------------------------------------------ | ------------------------- | ------------------------------ | ------------------------------------------------------------------------------------------------- |
| Security-проверки | Кол-во security-инструментов перед релизом | 0                         | 4 (SCA, SAST, Secrets, Policy) | `EVIDENCE/foodgo-sca-*.json`, `foodgo-sast-*.json`, `foodgo-secrets-*.json`, `foodgo-trivy-*.txt` |

До прохождения блока DS никаких security-сканов перед релизом не делалось.
После – перед важными изменениями запускаю минимум 4 инструмента и смотрю пороги/триаж.

---

## 8) Связь с TM и DV (сквозная нитка)

- Из TM закрываем часть угроз, связанных с:

  - **T04** – инъекции в полях заказа (SAST помогает мониторить такие места);
  - **T05** – отказ в обслуживании (policy-проверки по контейнеру и конфигам, базовый харднинг);
  - **T06** – утечка секретов в git (покрывается secrets scanning + практика с `.env`/Secrets).

- Связь с DV:

  - Всё, что сейчас запускается руками (SCA, SAST, Secrets, Policy), может быть встроено в CI из DV (pipeline `build_test` + отдельный `security` job).
  - Пороговые правила из этого файла – основа будущих quality-gates в конвейере.

---

## 9) Out-of-Scope

Осознанно **не делал** в этом минимальном примере:

1. Полноценный DAST-профиль по auth-flow и бизнес-сценариям (оставлено на более продвинутый уровень).
2. Проверки Kubernetes/оркестрации (предполагается простой Docker/Compose).
3. Детальную работу с лицензиями зависимостей (отмечено, но без отдельного отчёта).

---

## 10) Самооценка по рубрике DS (0/1/2)

> Оценка для этого примера (ориентир, «минимум на 1»):

- **DS1. SBOM и SCA:** [ ] 0 [x] 1 [ ] 2
- **DS2. SAST + Secrets:** [ ] 0 [x] 1 [ ] 2
- **DS3. DAST или Policy (Container/IaC):** [ ] 0 [x] 1 [ ] 2
- **DS4. Харднинг (доказуемый):** [ ] 0 [x] 1 [ ] 2
- **DS5. Quality-gates, триаж и «до/после»:** [ ] 0 [x] 1 [ ] 2

**Итог DS (сумма, пример):** 5/10
